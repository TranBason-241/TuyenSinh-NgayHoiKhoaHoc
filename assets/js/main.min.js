var _w = $(window).width();
var _h = $(window).height();
_heightBody = $("body").height();
var _clicked = 0,
  _data = {},
  _info = {};
// var ggAPI = "https://script.google.com/macros/s/AKfycbxUv48NWYIh4--asGCp_WY-lLmICSasCWHsgHg2aGwKo8uaM1dF_C2GBtOQf411uakW/exec";
var ggAPI = "";
var _linkSheet = "https://docs.google.com/spreadsheets/d/16ziy7hNuGV5FT2NOX8Oi46W5wMZdvAT-NuY_kPdil8g/edit#gid=0";
var regexPhone = /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/im;
var emailRegex = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
var orig_aid = "";
var fosp_aid = "";
var _hash = "";

$(document).ready(function () {
  if (getCookie("orig_aid") === undefined || getCookie("orig_aid") == "") {
    orig_aid = "";
  } else {
    orig_aid = getCookie("orig_aid");
  }

  if (getCookie("fosp_aid") === undefined || getCookie("fosp_aid") == "") {
    fosp_aid = "";
  } else {
    fosp_aid = getCookie("fosp_aid");
  }

  if (getCookie("fosp_uid") === undefined || getCookie("fosp_uid") == "") {
    fosp_uid = "";
  } else {
    fosp_uid = getCookie("fosp_uid");
  }

  _data["orig_aid"] = orig_aid;
  _data["fosp_aid"] = fosp_aid;
  _data["fosp_uid"] = fosp_uid;

  var currentUrl = window.location.href;
  var params = new URLSearchParams(currentUrl);
  let utmParams = {};
  for (const [key, val] of params) {
    if (key.startsWith("utm_")) {
      utmParams[key] = val;
    }
  }

  console.log(utmParams["utm_medium"]);
  _data["utm_medium"] = utmParams["utm_medium"];
  // console.log(currentUrl.searchParams.get("utm_medium"));

  // _hash = window.location.hash;

  // var uri_dec = decodeURIComponent(_hash);
  // var _valHash = uri_dec.replace('#ans=','').replace('&other=',',other=');
  // var _valAarry = _valHash.split(',');
  // var _txtQ4_7 = '';
  // var tmp =$('input[name="qes1_1"]');

  // for (let i = 1; i <= tmp.length; i++) {
  //     if(_valAarry.includes(i.toString())){
  //         $('#qes1_1-'+i).trigger('click');
  //     }
  // }

  // _valAarry.forEach((val,key) =>{
  //     if(_valAarry[key].indexOf('other=')==0){
  //         _txtQ4_7 = val.replace('other=','');
  //         $('#qes1-5__other').val(_txtQ4_7);
  //         $('#qes1-5').val(_txtQ4_7);
  //         _data['Vấn đề quản lý tài chính nào bạn đang quan tâm nhất?'] += '- '+_txtQ4_7
  //     }
  // })

  var _isMobile = /Android|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent || navigator.vendor || window.opera);
  const userAgent = navigator.userAgent.toLowerCase();
  const isTablet = /(ipad|tablet|(android(?!.*mobile))|(windows(?!.*phone)(.*touch))|kindle|playbook|silk|(puffin(?!.*(IP|AP|WP))))/.test(userAgent);

  if (_isMobile) {
    $("html").addClass("mobile");

    if (isTablet) {
      _data["device"] = "Tablet";
    } else {
      _data["device"] = "Mobile";
    }
  } else {
    $("html").addClass("pc");
    if (_heightBody < _h) {
      $("html").addClass("bodyS");
    }
    _data["device"] = "PC";
  }

  $("body").imagesStatus({
    allImgFinished: function (container) {
      AOS.init();
    },
  });

  $(".f-number").keypress(function (e) {
    if (8 != e.which && 0 != e.which && (e.which < 48 || 57 < e.which)) {
      return !1;
    }
  });

  $(".disable-paste").on("cut copy paste", function (e) {
    e.preventDefault();
  });

  $("body").click(function (e) {
    if (!$(e.target).is(".opt-custom , .opt-custom *")) {
      $(".opt-custom__list").removeClass("show");
    }
  });

  $('[data-toggle="dropdown"]').click(function () {
    var check = $(this).next().hasClass("show");
    $(".opt-custom__list").removeClass("show");
    $(this).next().toggleClass("show");

    if (check) {
      $(this).next().removeClass("show");
    }
  });

  //select option custom
  $(".opt-custom__list li").click(function () {
    var _tmp_data = "";
    var _c = $(this).attr("class");
    var _p = $(this).parents(".item");
    $("#qes2__other").val("");
    $("#qes2").prop("checked", false);

    if (_c === undefined) {
      var _v = $(this).text();
      var _g = $(this).parents(".opt-custom");
      _g.find(".opt-custom__value p").text(_v);
      _g.find(".opt-custom__value p").addClass("done");
      $('[data-toggle="dropdown"]').click();
      _tmp_data = _v;
      _data[_p.attr("id")] = _tmp_data;
      _g.find(".ipt-slt").val("");
      $(".opt-custom__list").removeClass("show");

      if (_data[_p.attr("id")] != "") {
        $('[id="' + _p.attr("id") + '"]')
          .parents(".card")
          .addClass("as-done");
      } else {
        $('[id="' + _p.attr("id") + '"]')
          .parents(".card")
          .removeClass("as-done");
      }
    }
  });

  // other keyup+ blur prop checked and check Required
  $(".ip-other__value").keyup(function () {
    if ($(this).val()) {
      $(this).parents(".ip-custom").find($("input")).prop("checked", true);
      $(this).parents(".ip-custom").find($('input:not([type="text"])')).attr("value", $(this).val());
    } else {
      $(this).parents(".ip-custom").find($("input")).prop("checked", false);
      $(this).parents(".ip-custom").find($('input:not([type="text"])')).attr("value", "");
    }
  });

  $(".ip-other__value").blur(function () {
    var _n = $(this).attr("name");
    var _p = $(this).parents(".item");

    if ($(this).val()) {
      $(this).parents(".ip-custom").find($("input")).prop("checked", true);
    } else {
      $(this).parents(".ip-custom").find($("input")).prop("checked", false);
    }
  });

  $(".form-control").on("keyup", function () {
    if ($(this).val()) {
      $(this).next().addClass("d-none");
    } else {
      $(this).next().removeClass("d-none");
    }
  });

  // send
  $(".btn-send").on("click", function () {
    var _current = parseInt($(".survey-inner__buttons").attr("data-current"));

    if (checkRequired(_current) == true) {
      if (_clicked == 0) {
        _clicked = 1;
        _data = $.extend({}, _data);
        sendForm(_data);
      }
    }
  });
  getHref();

  //Son custom

  var swiper = new Swiper(".mySwiper", {
    cssMode: true,
    navigation: {
      nextEl: ".swiper-button-next",
      prevEl: ".swiper-button-prev",
    },
    pagination: {
      el: ".swiper-pagination",
      clickable: true,
    },
    mousewheel: true,
    keyboard: true,
    loop: true,
    autoplay: {
      delay: 5000,
      disableOnInteraction: false,
    },
  });

  // placeholder only input
  listInput = document.querySelectorAll(".ipt input");
  listInput.forEach((element) => {
    console.log(element);
    element.addEventListener("input", (event) => {
      card = event.target.closest(".card");
      if (event.target.value.length > 0) {
        card.querySelector("h4").classList.add("d-none");
      } else {
        card.querySelector("h4").classList.remove("d-none");
      }
    });
  });

  // placeholder only select

  //   get list li
  liList = document.querySelectorAll(".opt-custom__list li");
  liList.forEach((e) => {
    e.addEventListener("click", (event) => {
      card = event.target.closest(".card");
      card.querySelector("h4").classList.add("d-none");
    });
  });

  listQuestionOnInput = document.querySelectorAll(".block h4");
  listQuestionOnInput.forEach((element) => {
    element.addEventListener("click", () => {
      block = element.closest(".block");
      input = block.querySelector("input");
      input.focus();
    });
  });
});

function getHref() {
  var _href = window.location.href.replace(_hash, "");
  $(".share-fb").attr("href", "https://www.facebook.com/sharer/sharer.php?u=" + _href);
  // $('.share-tt').attr('href','https://twitter.com/share?url='+_href)
  $("#copytext").val(_href);
}

function clipboard() {
  var copyText = document.getElementById("copytext");
  copyText.select();
  copyText.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(copyText.value);

  var tooltip = document.getElementById("myTooltip");
  tooltip.innerHTML = "Đã sao chép";
  if (document.getElementById("myTooltip2")) {
    var tooltip2 = document.getElementById("myTooltip2");
    tooltip2.innerHTML = "Đã sao chép";
  }
}

function outFunc() {
  var tooltip = document.getElementById("myTooltip");
  tooltip.innerHTML = "Sao chép link";

  if (document.getElementById("myTooltip2")) {
    var tooltip2 = document.getElementById("myTooltip2");
    tooltip2.innerHTML = "Sao chép link";
  }
}

function handleChangeInputv2(e) {
  var _tmp_data = "";
  var _n = $(e).attr("name");
  var _p = $(e).parents(".item");

  _p.addClass("open");
  var _v = $("input[name=" + _n + "]:checked").val();
  if (_data[_p.attr("id")] === undefined) {
    _tmp_data = _v;
    _data[_p.attr("id")] = _tmp_data;
  } else {
    let _txt = _data[_p.attr("id")];

    if (_v == "CÓ NGHE NHƯNG KHÔNG NẮM RÕ") {
      _txt = _txt.replace("ĐÃ NẮM RÕ", _v);
    } else {
      _txt = _txt.replace("CÓ NGHE NHƯNG KHÔNG NẮM RÕ", _v);
    }
    _data[_p.attr("id")] = _txt;
  }

  $('[id="' + _p.attr("id") + '"]')
    .parents(".card")
    .addClass("as-done");
}

function checkValid(e) {
  let _n = $(e).attr("name");
  let _v = $(e).val();

  if (_n == "email") {
    console.log(emailRegex.test(_v));

    if (emailRegex.test(_v)) {
      $(e).removeClass("er");
    }
  }
}

function handleChangeInput(e) {
  var _tmp_data = "";
  let _t = $(e).attr("type");
  let _n = $(e).attr("name");
  let _p = $(e).parents(".item");

  if (_t == "radio") {
    var _v = $("input[name=" + _n + "]:checked").val();
    checkDone(_v, _p);

    _tmp_data = _v;
  } else if (_t == "text") {
    var _other = $(e).hasClass("other");
    if (_other) {
      if (_p.data("limit")) {
        var _limit = _p.data("limit");
        if ($("input[name=" + _n + "]:checked").length > _limit) {
          Swal.fire({
            icon: "error",
            html: "Bạn đã chọn quá " + _limit + " lựa chọn",
          });

          $(e).val("");

          $.each($("input[name=" + _n + "]:checked"), function (index) {
            var _v = $(this).val();
            _v = _v.replace(/\s{2,}/g, " ");
            _v = "- " + _v;
            if (index == 0) {
              _tmp_data += _v;
            } else {
              _tmp_data += "\n" + _v;
            }
          });
        } else {
          $.each($("input[name=" + _n + "]:checked"), function (index) {
            var _v = $(this).val();
            _v = _v.replace(/\s{2,}/g, " ");
            _v = "- " + _v;
            if (index == 0) {
              _tmp_data += _v;
            } else {
              _tmp_data += "\n" + _v;
            }
          });
        }
      } else {
        $.each($("input[name=" + _n + "]:checked"), function (index) {
          var _v = $(this).val();
          _v = _v.replace(/\s{2,}/g, " ");
          _v = "- " + _v;
          if (index == 0) {
            _tmp_data += _v;
          } else {
            _tmp_data += "\n" + _v;
          }
        });
      }
    } else {
      if (_n == "email") {
        var _v = $(e).val().toLowerCase();
      } else {
        var _v = $(e).val();
      }
      _tmp_data = _v.trim();
    }
  } else if (_t == "checkbox") {
    if (_p.data("limit")) {
      var _limit = _p.data("limit");
      if ($("input[name=" + _n + "]:checked").length > _limit) {
        Swal.fire({
          icon: "error",
          html: "Bạn đã chọn quá " + _limit + " lựa chọn",
        });

        $(e).prop("checked", false);

        $.each($("input[name=" + _n + "]:checked"), function (index) {
          var _v = $(this).val();
          _v = _v.replace(/\s{2,}/g, " ");
          _v = "- " + _v;
          if (index == 0) {
            _tmp_data += _v;
          } else {
            _tmp_data += "\n" + _v;
          }
        });
      } else {
        $.each($("input[name=" + _n + "]:checked"), function (index) {
          var _v = $(this).val();
          _v = _v.replace(/\s{2,}/g, " ");
          _v = "- " + _v;
          if (index == 0) {
            _tmp_data += _v;
          } else {
            _tmp_data += "\n" + _v;
          }
        });
      }
    } else {
      $.each($("input[name=" + _n + "]:checked"), function (index) {
        var _v = $(this).val();
        if (_v) {
          _v = _v.replace(/\s{2,}/g, " ");
          _v = "- " + _v;
        }

        if (index == 0) {
          _tmp_data += _v;
        } else {
          _tmp_data += "\n" + _v;
        }
      });
    }
  } else {
    var _other = $(e).hasClass("other");
    if (_other) {
      $.each($("input[name=" + _n + "]:checked"), function (index) {
        var _v = $(this).val();
        _v = _v.replace(/\s{2,}/g, " ");
        _v = "- " + _v;
        if (index == 0) {
          _tmp_data += _v;
        } else {
          _tmp_data += "\n" + _v;
        }
      });
    } else {
      var _v = $(e).val();
      _tmp_data = _v.trim();
    }
  }

  _data[_p.attr("id")] = _tmp_data;
  console.log(_data);

  if (_data[_p.attr("id")] != "") {
    $('[id="' + _p.attr("id") + '"]')
      .parents(".card")
      .addClass("as-done");
  } else {
    if (
      !$('[id="' + _p.attr("id") + '"]')
        .parents(".card")
        .hasClass("notRequired")
    ) {
      $('[id="' + _p.attr("id") + '"]')
        .parents(".card")
        .removeClass("as-done");
    }
  }
}

function nextQuestion(idn, cls) {
  let _ele = $(idn + " " + cls);
  let _num = 0;

  $("#listQuestion-2 .card").addClass("hide");
  _ele.removeClass("hide");

  _ele.each(function (index, ele) {
    $(ele)
      .find(".black")
      .text(index + 1);
    $(ele).attr("data-question", "Bạn chưa trả lời Câu 3." + (index + 1));
  });
}

function handleChangeInputGroup(e) {
  var _tmp_data = "";
  var _t = $(e).attr("type");
  var _n = $(e).attr("name");
  var _p = $(e).parents(".item");
  var _pb = $(e).parents(".group-selected");

  if (_t == "radio") {
    var _v = $("input[name=" + _n + "]:checked").val();
    checkDone(_v, _p);

    _tmp_data = _v;
  }

  _data[_p.attr("id")] = _tmp_data;
  console.log(_data);
  checkDoneGroup(_pb);
}

function checkDone(_v, _p) {
  if (_v) {
    _p.addClass("as-done");
  } else {
    _p.removeClass("as-done");
  }
}

function checkDoneGroup(_pb) {
  console.log(_pb);

  let _numItem = _pb.find(".item").length;
  let _numItemDone = _pb.find(".as-done").length;
  if (_numItem == _numItemDone) {
    _pb.addClass("as-done");
  } else {
    _pb.removeClass("as-done");
  }
}

// start change text select option of input text
function handleChangeDrop(e) {
  var _tmp_data = "";
  var _n = $(e).attr("name");
  var _p = $(e).parents(".item");

  var _v = $(e).val();
  _tmp_data = _v.trim();

  _data[_p.attr("id")] = _tmp_data;
}

function changeText(e) {
  var _v = $(e).val();
  var _p = $(e).parents(".item");
  var _g = $(e).parents(".opt-custom");
  _g.find(".opt-custom__value p").text(_v);
  checkDone(_v, _p);
}
// end change text select option of input text

function emptySelectCountry() {
  $(".opt-custom__value p").text("");
}

function sendForm(_data) {
  $(".btn-send .loader").addClass("show");
  var name = _data["Họ và tên"];
  var phone = _data["Số điện thoại"];
  var email = _data["Email"];
  var age_range = _data["Độ tuổi của con"];

  $.ajax({
    url: ggAPI,
    type: "post",
    data: $.param(_data),
    success: function (data) {
      if (data.result == "success") {
        $(".btn-send .loader").removeClass("show");
        trackingFormBanner(name, phone, email, age_range);
        window.dataLayer = window.dataLayer || [];
        dataLayer.push({
          event: "voteEvent",
          vote_category: "FormDangKi_MDKH_2311",
          vote_action: "FormDangKi_MDKH_2311",
          category: "FormDangKi_MDKH_2311",
          action: _data["utm_medium"],
        });
        Swal.fire({
          icon: "success",
          showCloseButton: true,
          showClass: {
            popup: "SwalSocial",
          },
          title: "Gửi đăng ký thành công!",
          html:
            "<p>Cảm ơn bạn đã đăng ký thông tin.</p>" +
            "<p>Trường ISSP sẽ sớm liên hệ với bạn để xác nhận đăng ký</p>" +
            '<p class="mt-20">Tìm hiểu thêm về ISSP <a class="swal-link" target="_blank" href="https://www.issp.edu.vn/ngay-hoi-tuyen-sinh-mien-dat-khoa-hoc/?utm_source=Vnexpress_leadcampaign&utm_medium=organic&utm_campaign=VnExpress">tại đây</a></p>' +
            '<div class="social socialSwal"><ul><li><a class="share-fb" href="https://www.facebook.com/sharer/sharer.php?u=" target="_blank" title="share facebook"><i class="fab fa-facebook-f"></i></a></li><li><a class="copy-link tooltip" href="javascript:;" onclick="clipboard()" onmouseout="outFunc()"><i class="fas fa-link"></i><div id="myTooltip2" class="myTooltip">Sao chép link</div></a></li></ul></div>',
          confirmButtonText: "Quay lại VnExpress",
        }).then((result) => {
          if (result.isConfirmed || result.isDismissed) {
            _clicked = 1;
            setTimeout(() => {
              window.location.href = "https://vnexpress.net/";
            }, 300);
          }
        });
        _data = {};
        getHref();
      } else {
        Swal.fire({
          icon: "error",
          title: "Gửi không thành công!",
          text: "Vui lòng trả lời đầy đủ câu hỏi!",
        });
      }
    },
  });
}

function trackingFormBanner(name, phone, email, age_range) {
  var logForm = window._logForm || (window._logForm = []);
  logForm.push({
    campaign_name: "FormDangKi_MDKH_2311", //name của ca
    engagement_type: "1003",
    source_name: "Vnexpress", // Hệ thống tự push vào
    source_type: "internal",
    index_brand: "FormDangKi_MDKH_2311",
    index_industrial: "",
    index_category: "",
    index_topic: "",

    //Nhập thông tin của audience
    name: name, // nhập tên audience (option)
    phone: phone,
    gender: "",
    age: "",
    birth_day: "",
    age_range: age_range, // (Optional): 18-24/ 25-34/ 35-44/ 45-54/ 55-64/ 65+. VD: 25-34
    email: email,
  });
}

function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(";");
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == " ") {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

function focusElement(e) {
  var _p = $(e).parents(".item");
  var _o = $(e).parent().find(".ip-other__value");
  var _n = $(e).attr("name");
  if ($(e).is(":checked")) {
    _o.focus();
  } else {
    $(e).attr("value", "");
    _o.val("");
    checkDoneCheckbox(_n, _p);
  }
}

function checkDoneCheckbox(name, parent) {
  var _e = $("input[name=" + name + "]:checked").length;
  if (_e) {
    parent.addClass("as-done");
  } else {
    parent.removeClass("as-done");
  }
}

function onNext(e) {
  var _current = parseInt($(e).parent().attr("data-current"));
  var _prevID = _current - 1;
  let _nextID = _current + 1;
  var r = $("html, body");

  if (checkRequired(_current) == true) {
    if (_current == 3 && _data["Ngành nghề kinh doanh chính"] == "Công nghiệp chế biến, chế tạo") {
      _nextID = 4;
    }

    r.animate(
      {
        scrollTop: 0,
      },
      "slow"
    );

    setTimeout(function () {
      $(e).parent().attr("data-current", _nextID);
      $(".section-step").removeClass("show");
      $("#listQuestion-" + _nextID).addClass("show");
      if (_nextID == 3 || _nextID == 4) {
        $(".tt-btn--next").removeClass("show");
        $(".btn-send").addClass("show");
      } else {
        $(".tt-btn--prev").addClass("show");
      }
    }, 500);
  }
}

function onPrev(e) {
  var _current = parseInt($(e).parent().attr("data-current"));
  var _prevID = _current - 1;

  if (_current == 3 && _data["Bạn có biết một trong các nội dung sau đây không?"] == "Không") {
    _prevID = 1;
  }

  if (_current == 8 && _data["Ngành nghề kinh doanh chính của doanh nghiệp bạn"] == "Công nghiệp chế biến, chế tạo") {
    _prevID = 6;
  }

  if (_current == 8 || _current == 7) {
    $(".tt-btn--next").addClass("show");
    $(".btn-send").removeClass("show");
  }

  $(e).parent().attr("data-current", _prevID);

  var r = $("html, body");
  r.animate(
    {
      scrollTop: 0,
    },
    "slow"
  );

  setTimeout(function () {
    $(".section-step").removeClass("show");
    $("#listQuestion-" + _prevID).addClass("show");
    if (_current == 2) {
      $(".tt-btn--prev").removeClass("show");
    } else if (_current <= 4) {
      $(".btn-send").removeClass("show");
      $(".tt-btn--next").addClass("show");
    } else {
      $(".tt-btn--prev").addClass("show");
    }
  }, 500);
}

function checkRequired(currentPage) {
  let _numItem = $("#listQuestion-" + currentPage + ".show .card:not(.hide)").length;
  let _numReq = $("#listQuestion-" + currentPage + ".show .card.as-done:not(.hide)").length;

  $.each($(".survey-inner__content .as-done"), function (index) {
    $(this).find(".required").removeClass("show");
    $(this).removeClass("required");
  });
  console.log(_numItem + "---" + _numReq);

  if (_numItem == _numReq) {
    if (!emailRegex.test(_data["Email"]) && _data["Email"] !== undefined) {
      Swal.fire({
        icon: "error",
        title: "Email không đúng định dạng",
        confirmButtonText: "Đóng",
      }).then((result) => {
        if (result.isConfirmed) {
          $('input[name="email"]').addClass("er");
          setTimeout(function () {
            $('input[name="email"]').focus();
          }, 300);
        }
      });
      return false;
    }
    return true;
  } else {
    $.each($("#listQuestion-" + currentPage + ".show .card:not(.as-done):not(.hide)"), function (index, ele) {
      if (index == 0) {
        var _textQuestion = $(ele).data("question");

        Swal.fire({
          icon: "error",
          text: _textQuestion,
        }).then((result) => {
          $(ele).find(".required").addClass("show");
          $(ele).addClass("required");
          var r = $("html, body");
          r.animate(
            {
              scrollTop: $(ele).offset().top - 55,
            },
            "slow"
          );
        });
      }
    });
  }
}
